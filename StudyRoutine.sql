---------< 메인화면 >----------

-- STUDENT 테이블 생성
CREATE TABLE STUDENT (
	STUDENT_NO NUMBER PRIMARY KEY,
	STUDENT_ID VARCHAR2(30) NOT NULL,
	STUDENT_PW VARCHAR2(30) NOT NULL,
	STUDENT_NM VARCHAR2(30) NOT NULL,
	STUDENT_GENDER CHAR(1) CHECK(STUDENT_GENDER IN ('M','F')),
	STUDENT_PHONE VARCHAR2(20) NOT NULL,
	ENROLL_DATE DATE DEFAULT SYSDATE,
	SECESSION_FL CHAR(1) DEFAULT 'N' CHECK(SECESSION_FL IN ('Y','N'))
);

COMMENT ON COLUMN STUDENT.STUDENT_NO IS '회원번호';
COMMENT ON COLUMN STUDENT.STUDENT_ID IS '회원 아이디';
COMMENT ON COLUMN STUDENT.STUDENT_PW IS '회원 비밀번호';
COMMENT ON COLUMN STUDENT.STUDENT_NM IS '회원 이름';
COMMENT ON COLUMN STUDENT.STUDENT_GENDER IS '회원 성별';
COMMENT ON COLUMN STUDENT.STUDENT_PHONE IS '회원 전화번호';
COMMENT ON COLUMN STUDENT.ENROLL_DATE IS '회원 가입일';
COMMENT ON COLUMN STUDENT.SECESSION_FL IS '탈퇴여부(Y/N)';

-- SEQUENCE 생성
CREATE SEQUENCE SEQ_NO_STD NOCACHE;

-- STUDENT 샘플 데이터 삽입
INSERT INTO STUDENT VALUES(SEQ_NO_STD.NEXTVAL, 'std01', 'pass01', '김길동', 'M', '010-1234-1234', DEFAULT, DEFAULT);
INSERT INTO STUDENT VALUES(SEQ_NO_STD.NEXTVAL, 'std02', 'pass02', '이지인', 'F', '010-1357-7073', DEFAULT, DEFAULT);
INSERT INTO STUDENT VALUES(SEQ_NO_STD.NEXTVAL, 'std03', 'pass03', '박주은', 'F', '010-3490-4558', DEFAULT, DEFAULT);
INSERT INTO STUDENT VALUES(SEQ_NO_STD.NEXTVAL, 'std04', 'pass04', '서민준', 'M', '010-2050-4620', DEFAULT, DEFAULT);

COMMIT;

-- 로그인
SELECT STUDENT_NO, STUDENT_ID, STUDENT_NM, STUDENT_GENDER, STUDENT_PHONE,
	TO_CHAR(ENROLL_DATE, 'YYYY"년" MM"월" DD"일" HH24:MI:SS') ENROLL_DATE
FROM STUDENT
WHERE STUDENT_ID = 'std01'
AND STUDENT_PW = 'pass01'
AND SECESSION_FL = 'N';

SELECT * FROM STUDENT;
-- 회원가입
INSERT INTO STUDENT 
VALUES(SEQ_NO_STD.NEXTVAL, 'std05', 'pass05', '진미정', 'F', '010-1111-7777', DEFAULT, DEFAULT);

-- 아이디 중복 검사
SELECT COUNT(*)
FROM STUDENT
WHERE STUDENT_ID = 'std01'
AND SECESSION_FL = 'N';

-- 아이디 찾기
SELECT STUDENT_ID
FROM STUDENT
WHERE STUDENT_NM = '김길동'
AND STUDENT_PHONE = '010-1234-1234';


---------<공부 루틴 만들기>-------------

-- 루틴 명단 생성
CREATE TABLE ROUTINE(
	RT_NO NUMBER PRIMARY KEY,
	RT_NAME VARCHAR2(50) NOT NULL,
	STUDENT_NO NUMBER REFERENCES STUDENT(STUDENT_NO) ON DELETE CASCADE
);

COMMENT ON COLUMN ROUTINE.RT_NO IS '루틴 번호';
COMMENT ON COLUMN ROUTINE.RT_NAME IS '루틴 이름';
COMMENT ON COLUMN ROUTINE.STUDENT_NO IS '회원 번호';

SELECT * FROM ROUTINE;

CREATE SEQUENCE SEQ_NO_RT NOCACHE;

INSERT INTO ROUTINE VALUES(SEQ_NO_RT.NEXTVAL, '복습하기', 1);
INSERT INTO ROUTINE VALUES(SEQ_NO_RT.NEXTVAL, '운동하기', 1);
INSERT INTO ROUTINE VALUES(SEQ_NO_RT.NEXTVAL, '6시 기상', 1);
INSERT INTO ROUTINE VALUES(SEQ_NO_RT.NEXTVAL, '아침 먹기', 2);
INSERT INTO ROUTINE VALUES(SEQ_NO_RT.NEXTVAL, '복습하기', 2);

SELECT RT_NO, RT_NAME, STUDENT_NO, STUDENT_NM
FROM ROUTINE
LEFT JOIN STUDENT USING(STUDENT_NO);

COMMIT;


--------<매일 기록 체크>-------------
-- 체크리스트 생성

--DROP TABLE CHECK_RT;

CREATE TABLE CHECK_RT(
	CHECK_NO NUMBER PRIMARY KEY,
	RT_NO NUMBER REFERENCES ROUTINE(RT_NO) ON DELETE CASCADE,
	CHECK_RT VARCHAR2(10) NOT NULL,
	CHECK_DATE DATE DEFAULT SYSDATE
);

COMMENT ON COLUMN CHECK_RT.CHECK_NO IS '체크 번호';
COMMENT ON COLUMN CHECK_RT.RT_NO IS '루틴 번호';
COMMENT ON COLUMN CHECK_RT.CHECK_RT IS '루틴 체크';
COMMENT ON COLUMN CHECK_RT.CHECK_DATE IS '기록 날짜';

CREATE SEQUENCE SEQ_NO_CHECK NOCACHE;

INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 1, 'O', '2022-09-01');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 2, 'O', '2022-09-01');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 3, 'O', '2022-09-01');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 4, 'O', '2022-09-01');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 5, 'O', '2022-09-01');

INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 1, 'O', '2022-09-02');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 2, 'O', '2022-09-02');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 3, 'O', '2022-09-02');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 4, 'O', '2022-09-02');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 5, 'O', '2022-09-02');

INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 1, 'O', '2022-09-03');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 2, 'O', '2022-09-03');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 3, 'O', '2022-09-03');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 4, 'O', '2022-09-03');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 5, 'O', '2022-09-03');

INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 1, 'O', '2022-09-04');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 2, 'X', '2022-09-04');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 3, 'O', '2022-09-04');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 4, 'O', '2022-09-04');
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 5, 'X', '2022-09-04');

INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 1, 'O', TO_DATE('22/9/5'));
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 2, 'O', TO_DATE('22/'||'9/5'));
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 3, 'X', TO_DATE('22/'||'9/5'));
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, 4, 'O', TO_DATE('22/'||'9/5'));

DELETE FROM CHECK_RT WHERE CHECK_NO = 27;

SELECT * FROM CHECK_RT
JOIN ROUTINE USING(RT_NO)
WHERE STUDENT_NO =1;

COMMIT;


--SELECT TO_DATE('22/7/21') FROM DUAL;


-- 나의 루틴 전체 조회
SELECT RT_NAME, RT_NO
FROM ROUTINE
WHERE STUDENT_NO = 1
AND SECESSION_FL = 'N';

-- 루틴 기록
INSERT INTO CHECK_RT VALUES(SEQ_NO_CHECK.NEXTVAL, ?, ?, ?);

SELECT * FROM STUDENT;	
SELECT * FROM ROUTINE;
-- 루틴 추가
INSERT INTO ROUTINE VALUES(SEQ_NO_RT.NEXTVAL, '운동하기', 3);


SELECT RT_NAME, CHECK_RT, CHECK_DATE
FROM CHECK_RT
JOIN ROUTINE USING(RT_NO)
WHERE STUDENT_NO = 1
GROUP BY CHECK_DATE;

SELECT (SELECT RT_NAME FROM ROUTINE WHERE STUDENT_NO = 1)
FROM CHECK_RT C;

-- 회원 정보 수정
UPDATE STUDENT
SET STUDENT_NM = '김지민',
STUDENT_PHONE = '010-2050-7831'
WHERE STUDENT_NO = 6;

ROLLBACK;

-- 비밀번호 변경
UPDATE STUDENT
SET STUDENT_PW = 'pass1234'
WHERE STUDENT_NO = 1
AND STUDENT_PW = 'pass01';


-- 한달 루틴 보기
SELECT * 
FROM (SELECT RT_NO, RT_NAME, CHECK_RT, TO_CHAR(CHECK_DATE, 'DD')  CHECK_DATE
    FROM CHECK_RT
    JOIN ROUTINE USING(RT_NO)
    WHERE STUDENT_NO = 4
    AND EXTRACT(MONTH FROM CHECK_DATE) = 9
    AND SECESSION_FL = 'N')
PIVOT( MIN(CHECK_RT) 
FOR CHECK_DATE
IN ('01', '02', '03', '04', '05',
   '06', '07', '08', '09' ,'10',
   '11', '12', '13', '14' ,'15',
   '16', '17', '18', '19' ,'20',
   '21', '22', '23', '24' ,'25',
   '26', '27', '28', '29' ,'30', '31'
));
-- List< Map<String, String> >

--           컬럼명,  값
--           "rtNo" ,  "1"
--         "reName" , "복습하기"
--            "01" , "O"
--            "02" , "X"

--           "rtNo" ,  "2"
--         "reName" , "운동하기"
--           "01" , "O"
--            "02" , "X"

--           "rtNo" ,  "3"
--         "reName" , "6시 기상"
--           "01" , "O"
--            "02" , "X"

/*
 * while(rs.next){
 *    Map<String,String> map = new LinkedHashMap<>();
 *  map.put("rtNo" , rs.getInt("RT_NO") + "" );
 *  map.put("rtName" , rs.getString("RT_NAME") );
 * 
 *  for(int i=1 ; i<=31 ; i++){
 *       String col = i < 10 ? "0" + i : "" + i;      
 *        map.put(col , rs.getString(col) );
 * 
 *  }
 *
 *  list.add(map);
 * } 
 * 
 * */





SELECT TO_CHAR(CHECK_DATE, 'YYYY-MM-DD')
FROM CHECK_RT
JOIN ROUTINE USING(RT_NO)
WHERE STUDENT_NO = 1
AND EXTRACT(MONTH FROM CHECK_DATE) = 9   
GROUP BY TO_CHAR(CHECK_DATE, 'YYYY-MM-DD')
ORDER BY 1;
--> List<String> 날짜 저장

SELECT RT_NAME, CHECK_RT
FROM CHECK_RT
JOIN ROUTINE USING(RT_NO)
WHERE STUDENT_NO = 1
AND CHECK_DATE = '2022-09-05' -- 위 SELECT 결과 1행씩 대입
ORDER BY RT_NO;

-- List< List <  VO(rtName, checkRt)  >  >


COMMIT;

SELECT * FROM ROUTINE;

UPDATE ROUTINE SET RT_NAME = '아침먹기'
WHERE RT_NO = 4;

SELECT * FROM STUDENT;

--회원 탈퇴
UPDATE STUDENT SET SECESSION_FL='N'
WHERE STUDENT_NO = 6;

ROLLBACK;



-- 성적 테이블 만들기

CREATE TABLE SCORE (
	TEST_NO NUMBER PRIMARY KEY, 
	TEST_DATE DATE DEFAULT SYSDATE,
	TEST_SCORE NUMBER NOT NULL,
	STUDENT_NO NUMBER REFERENCES STUDENT(STUDENT_NO) ON DELETE CASCADE
)

DROP TABLE SCORE;

SELECT * FROM SCORE;

COMMENT ON COLUMN SCORE.TEST_NO IS '시험번호';
COMMENT ON COLUMN SCORE.TEST_DATE IS '시험일';
COMMENT ON COLUMN SCORE.TEST_SCORE IS '시험성적';
COMMENT ON COLUMN SCORE.STUDENT_NO IS '회원번호';

CREATE SEQUENCE SEQ_NO_TEST NOCACHE;

INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '2022-09-01', 75, 1);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '2022-09-01', 80, 2);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '2022-09-01', 100, 3);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '22-09-02', 80, 4);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '22-09-08', 75, 1);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '22-09-15', 80, 1);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '22-09-07', 88, 2);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '22-09-13', 77, 2);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '22-09-13', 95, 3);
INSERT INTO SCORE VALUES(SEQ_NO_TEST.NEXTVAL, '22-09-18', 89, 3);

COMMIT;

SELECT TO_CHAR(TEST_DATE, 'MM/DD (DY)') TEST_DATE, TEST_SCORE
FROM SCORE
WHERE STUDENT_NO = 1;

SELECT * FROM ROUTINE;

ALTER TABLE ROUTINE ADD(SECESSION_FL CHAR(1) DEFAULT 'N' CHECK(SECESSION_FL IN ('Y','N')));

UPDATE ROUTINE SET SECESSION_FL = 'Y'
WHERE RT_NO = 7;

UPDATE ROUTINE SET RT_NAME = '운동하기'
WHERE RT_NO = 9;

SELECT * FROM STUDENT;

SELECT *
FROM CHECK_RT
WHERE RT_NO = 2
AND CHECK_DATE = '2022-09-05';

UPDATE CHECK_RT
SET CHECK_RT = 'O'
WHERE CHECK_DATE = TO_DATE('22/'||'9/5');
